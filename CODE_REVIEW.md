# コードレビューレポート

**レビュー日**: 2026-01-07
**プロジェクト**: Full-Search-PDFs (全文検索サーバー)
**バージョン**: 1.0.0
**技術スタック**: FastAPI + Vanilla JS
**対象ファイル**: `web_server.py`, `static/app.js`, `static/index.html`, `static/styles.css`
**想定利用環境**: 社内LAN / 家庭内LAN（信頼されたネットワーク）

---

## 前提条件

本レビューは、以下の利用環境を前提としています：

- **利用範囲**: 社内LAN / 家庭内LANに限定
- **ユーザー**: 信頼された組織内のメンバー
- **ネットワーク**: ルーター/ファイアウォールで外部からのアクセスを遮断
- **データソース**: 社内/家庭内の文書（PDF、Office）

この前提を踏まえ、セキュリティリスクの評価を行いました。

---

## 1. セキュリティ（LAN内利用を前提とした評価）

### ✅ 問題なし

#### 1.1 CORS設定 (`web_server.py:1414-1420`)
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```
**評価**: LAN内では、様々なデバイス（PC、タブレット、スマホ）から異なるIPアドレス経由でアクセスするため、`allow_origins=["*"]` は妥当な設定です。外部からのアクセスはネットワーク機器で遮断されている前提です。

#### 1.2 Pickleの使用 (`web_server.py:1180-1183`)
```python
with gzip.open(idx_path, "rb") as f:
    data = pickle.load(f)
```
**評価**: インデックスファイルはアプリ自身が `indexes/` ディレクトリに生成するものであり、外部からの入力ではありません。信頼されたファイルシステム上での動作を前提としているため、安全です。

#### 1.3 XSS対策 (`app.js:446-468`)
**評価**: データソースは社内のPDF/Office文書（信頼されたソース）であり、ユーザーも信頼されたメンバーです。検索クエリは `escapeRegex()` で正規表現特殊文字をエスケープ済みです。LAN内利用では実質的なリスクは低いです。

### 🟡 注意事項（インターネット公開時のみ対応が必要）

以下の項目は、将来的にインターネットに公開する場合に対応を検討してください：

1. **CORS設定の制限**: 特定のオリジンに制限
2. **HTMLエスケープの追加**: `highlightText()` でのXSS対策強化
3. **入力検証の強化**: 検索クエリの長さ制限と特殊文字処理

---

## 2. パフォーマンス

### 🟢 良い設計

#### 2.1 メモリキャッシュ (`web_server.py:1708-1765`)
LRUキャッシュの実装は適切で、メモリ上限とエントリ数の両方を管理しています。

#### 2.2 並列処理 (`web_server.py:876-947`)
ThreadPoolExecutor/ProcessPoolExecutorを適切に使い分けており、大量データの検索を効率化しています。

#### 2.3 正規表現のコンパイル (`web_server.py:60-64`)
正規表現はモジュールレベルでコンパイル済みで、パフォーマンス最適化されています。

### 🟡 改善の余地

#### 2.4 重複したIPアドレス取得関数 (`web_server.py:134-170` と `2533-2569`)
**問題**: `get_ipv4_addresses()` 関数がファイル内で2回定義されています。
**推奨**: 共通関数として1箇所にまとめる。

#### 2.5 検索ロジックの冗長性 (`web_server.py:531-668` と `740-846`)
**問題**: `search_text_logic` と `search_text_logic_shared` にほぼ同じロジックが存在します。
**推奨**: 共通処理を抽出してDRY原則を適用（中長期課題）。

---

## 3. コード品質

### 🟢 良い設計

#### 3.1 例外処理のフォールトトレランス (`web_server.py:919-924`)
```python
except Exception:
    continue
```
**評価**: 検索処理中に1つのファイルでエラーが発生しても、他のファイルの検索を続行する設計は妥当です。1つの壊れたPDFのせいで検索全体が失敗するのは望ましくありません。デバッグ時には `SEARCH_DEBUG=1` 環境変数でログを有効化できます。

#### 3.2 グローバル状態管理 (`web_server.py:1502-1532`)
**評価**: シングルプロセスで動作するFastAPIアプリとして、起動時にグローバル状態を初期化するのは標準的なアプローチです。セキュリティ問題ではありません。

### 🟡 中長期的な改善課題

#### 3.3 関数の責務分割 (`web_server.py:2222-2288`)
`startup_event` 関数が約70行で、複数の責務を担っています。
**推奨**: 各責務を個別の関数に分割（保守性向上）。

#### 3.4 マジックナンバーの定数化
```python
if len(entries_iter) >= 2000:  # web_server.py:898
detail_window = 2000  # web_server.py:826
```
**推奨**: 定数として定義し、意味のある名前を付ける。

#### 3.5 型ヒントの改善
**推奨**: 返り値の `Dict` に詳細な型ヒントを追加。

---

## 4. フロントエンド (app.js)

### 🟢 良い設計

#### 4.1 状態管理 (`app.js:7-23`)
単一の状態オブジェクトで管理しており、理解しやすい設計です。

#### 4.2 無限スクロール (`app.js:618-643`)
パフォーマンスを考慮したバッチレンダリングが適切に実装されています。

#### 4.3 クリップボード操作 (`app.js:55-104`)
パーミッション確認とフォールバック処理が適切に実装されています。

### 🟡 改善の余地

#### 4.4 ハードコードされた文字列
日本語UIテキストがコード内にハードコードされています。
**推奨**: 国際化を視野に入れる場合は、メッセージを外部化（現状では問題なし）。

---

## 5. CSS (styles.css)

### 🟢 良い設計

#### 5.1 CSS変数の活用 (`styles.css:7-50`)
ライト/ダークテーマを CSS変数で切り替えており、保守性が高いです。

#### 5.2 レスポンシブデザイン (`styles.css:1041-1137`)
メディアクエリで適切にレイアウトを調整しています。

### 🟡 軽微な改善点

#### 5.3 ハードコードされた色 (`styles.css:409`)
`#fff` などの一部の色がCSS変数化されていません。
**推奨**: 一貫性のためCSS変数化（優先度低）。

---

## 6. 構造と保守性

### 🟡 中長期的な改善課題

#### 6.1 ファイルサイズ
`web_server.py` が2,575行で1ファイルに集約されています。現状の規模では管理可能ですが、機能追加時にはモジュール分割を検討。

**将来の推奨構成**:
```
src/
├── main.py              # FastAPIアプリのエントリポイント
├── routes/              # APIエンドポイント
├── services/            # ビジネスロジック
├── extractors/          # テキスト抽出
└── utils/               # ユーティリティ
```

#### 6.2 テストの整備
テストコードが存在しません。重要な機能追加やリファクタリング時には、テストフレームワーク（pytest）の導入を検討。

---

## 7. 総合評価

| カテゴリ | 評価 | コメント |
|---------|------|----------|
| セキュリティ | ✅ | LAN内利用では適切な設計 |
| パフォーマンス | ✅ | キャッシュ・並列処理は良好 |
| コード品質 | ✅ | 現状の規模では適切 |
| 保守性 | 🟡 | 将来的なモジュール分割を推奨 |
| フロントエンド | ✅ | 良好な実装 |
| テスタビリティ | 🟡 | テスト整備は中長期課題 |

---

## 8. 推奨対応事項

### 短期（任意）
1. `get_ipv4_addresses()` の重複定義を統合

### 中長期（機能拡張時に検討）
1. ファイル分割によるモジュール化
2. テストフレームワークの導入
3. マジックナンバーの定数化

### インターネット公開時のみ必要
1. CORS設定の制限
2. HTMLエスケープの追加
3. 入力検証の強化

---

## 9. 結論

本プロジェクトは、社内LAN/家庭内LANでの利用を前提とした全文検索サーバーとして、適切に設計・実装されています。

当初「重大な問題」として挙げた5件は、LAN内利用の前提を踏まえると、いずれも実質的なセキュリティリスクではないことを確認しました：

| 項目 | 再検証結果 |
|------|-----------|
| CORS設定 | LAN内の様々なデバイスからのアクセスに必要な設定 |
| Pickle使用 | アプリ自身が生成したファイルのみを読み込むため安全 |
| XSS対策 | 信頼されたデータソースと利用者のため実質リスクなし |
| グローバル変数 | セキュリティ問題ではなく、標準的な設計パターン |
| 例外の黙殺 | フォールトトレランスとして妥当な設計 |

今後の機能拡張やインターネット公開を検討する際には、該当するセキュリティ対策を追加してください。

---

*レビュー作成: Claude Code Review*
*最終更新: 2026-01-07（LAN内利用を前提とした再検証を実施）*
