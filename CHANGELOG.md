# 変更履歴

System Version: 1.1.0

## 1.1.0

- 2026-01-08: 機能追加: 世代ディレクトリ方式のインデックス再構築を実装（無停止運用対応）。
  - `indexes/gen_<uuid>/` に世代ごとのインデックスを保存
  - `indexes/.build/gen_<uuid>/` で新世代を構築後、原子的に切替
  - `indexes/current.txt` で現在の世代を管理
  - `manifest.json` で世代メタデータを記録
- 2026-01-08: 機能追加: インデックス世代の保持ポリシーを実装（無限増殖防止）。
  - `INDEX_KEEP_GENERATIONS`: 保持する世代数（デフォルト: 3）
  - `INDEX_KEEP_DAYS`: 保持する日数（0=無制限）
  - `INDEX_MAX_BYTES`: 最大容量（0=無制限）
  - `INDEX_CLEANUP_GRACE_SEC`: 切替後の猶予期間（デフォルト: 300秒）
- 2026-01-08: ドキュメント: README.md にロールバック手順を追加。
- 2026-01-08: バグ修正: 差分更新ロジックの修正（前回の世代から既存キャッシュを読み込むように改善）。
- 2026-01-08: 機能追加: 既存のフラットなインデックスから世代ディレクトリへの自動移行処理を実装。
- 2026-01-08: リファクタリング: cleanup_old_generations のロジックを簡素化（可読性向上）。
- 2026-01-08: バグ修正: build_all_indexes のエラーハンドリング改善（失敗時にビルドディレクトリを確実に削除）。
- 2026-01-08: バグ修正: INDEX_MAX_BYTES が現在の世代を含むように修正（P2 Badge 指摘対応）。
  - 全世代の合計ディスク使用量で判断するように変更
  - ドキュメントに動作を明記
- 2026-01-08: バグ修正: INDEX_MAX_BYTES の計算に猶予期間中の世代も含むように修正。
  - 猶予期間中の世代は削除されないが、サイズ計算には含まれる
  - 「現在＋猶予＋保持世代」の実使用量で上限判定を行うように改善
- 2026-01-08: ドキュメント: .env.example.txt の INDEX_MAX_BYTES コメントを README と整合させた。
- 2026-01-08: バグ修正: current.txt 欠落時の復旧ロジックを追加。
  - current.txt がない場合、最新の世代を自動選択して復旧
  - 検索・差分更新の挙動が安定化
- 2026-01-08: バグ修正: list_generations のソート時に manifest がない世代を正しく扱うように修正。
  - manifest がない場合、gen_name からタイムスタンプを抽出してフォールバック
  - current.txt 自動復旧時に本当の最新世代を確実に選択
- 2026-01-08: リファクタリング: マジックナンバーを定数として抽出（検索表示、パフォーマンス、キャッシュ関連）。
- 2026-01-08: リファクタリング: 重複した検索ロジック関数を共通ヘルパー関数に統合（`_find_raw_hit_position`, `_build_search_result`）。
- 2026-01-08: リファクタリング: `/api/search` エンドポイントのキャッシュ取得ロジックをヘルパー関数に抽出（`_try_get_memory_cache`, `_try_get_fixed_cache`）。
- 2026-01-08: 不要な静的ファイル `index - コピー.html` を削除。
- 2026-01-08: 機能追加: 段階的ハッシングによる差分更新の精度向上（issue #4 対応）。
  - `file_state.jsonl` による前回状態の保存・参照（DB不要）
  - 段階的な差分判定: stat（size + mtime_ns + inode/file_id） → fast fingerprint → full hash
  - `DIFF_MODE` 設定: `stat` / `stat+fastfp` / `stat+fastfp+fullhash`（デフォルト: `stat`）
  - fast fingerprint: 先頭/末尾チャンクのハッシュ（`FAST_FP_BYTES` で設定可能、デフォルト: 64KB）
  - full hash: 条件付きフルハッシュ（`FULL_HASH_ALGO`, `FULL_HASH_PATHS`, `FULL_HASH_EXTS` で設定可能）
  - 削除検知の安全策: 2回連続で不在の場合のみ削除として扱う（瞬断対策）
  - mtime保持・同サイズ更新などの見逃しを防止
- 2026-01-08: バグ修正: 段階的ハッシング設定のパースを安全化（レビュー指摘対応）。
  - `FAST_FP_BYTES` の不正値・非数値でもデフォルトにフォールバック（例外回避）
  - `FULL_HASH_ALGO` の空文字もデフォルトにフォールバック
  - `file_state.jsonl` の部分破損に対応（行単位でスキップ、全体失敗を回避）
- 2026-01-08: バグ修正: 削除検知の安全策を修正（レビュー指摘対応）。
  - valid_cache のフィルタ順序を変更し、削除候補が正しく機能するように修正
  - 1回目の不在時にインデックスに残し、2回目の不在で削除する仕様を正しく実装
  - ネットワーク瞬断での誤削除を防止
  - 削除確定時のログを `log_warn` に変更し、文言を「削除確定（インデックス除外）」に明確化
  - `log_notice` 関数を追加（黄色表示）し、削除候補ログを `log_notice` に変更して視認性を向上

## 1.0.0

- 2026-01-07: README に LAN 内利用を前提としている旨の注意書きを追加。
- 2026-01-07: Claude Code 向けの `CLAUDE.md` を追加。
- 2025-01-06: インデックス構築、検索、UI、キャッシュ、スケジュール更新を統合した初版リリース。
- 2025-01-06: Linux/macOS 向けの簡易起動スクリプト `run.sh` を追加し、README に手順を追記。
- 2025-01-06: Windows の process モードのメモリ増加に関する注意書きを更新（共有 mmap の説明を追記）。
